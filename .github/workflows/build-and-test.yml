name: CI + CD - Build, Scan, Sign & Verify

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  id-token: write  

env:
  IMAGE_REF: ${{ secrets.DOCKER_USERNAME }}/librarymanagementsystem-webapi
  REPORT_PATH: Reports/LibraryAPITestReport.html
  SBOM_FILE: sbom.json

jobs:

  build-test-scan:
    runs-on: ubuntu-latest

    outputs:
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      # Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # .NET build
      - name: Restore dependencies
        run: dotnet restore

      - name: Build application
        run: dotnet build Library.WebApi/Library.WebApi.csproj --no-restore

      # Docker login
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Dependency scan
      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          severity: HIGH,CRITICAL
          exit-code: 0

      # Docker build & push 
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Library.WebApi/Dockerfile
          push: true
          tags: ${{ env.IMAGE_REF }}:latest

    
      # SBOM
      - name: Generate SBOM
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: image
          image-ref: ${{ env.IMAGE_REF }}:latest
          format: cyclonedx
          output: ${{ env.SBOM_FILE }}

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json


      # Image vulnerability scan
      - name: Scan Docker image
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: image
          image-ref: ${{ env.IMAGE_REF }}:latest
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: 1

      # API tests
      - name: Start Services
        env:
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          docker compose up -d
          sleep 15
          

      - name: Install Newman
        run: npm install -g newman newman-reporter-htmlextra

      - name: Run API Tests via Newman
        run: |
          newman run library-api-tests.postman_collection.json \
            -e library-api-env.postman_environment.json \
            --reporters cli
      
      
      - name: Stop containers
        if: always()
        run: docker compose down


  sign-and-verify:
    needs: build-test-scan
    runs-on: ubuntu-latest

    env:
      DIGEST: ${{ needs.build-test-scan.outputs.image-digest }}

    steps:
      # Install Cosign
      - name: Install Cosign
        run: |
          curl -sSL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 -o cosign
          chmod +x cosign
          sudo mv cosign /usr/local/bin/cosign
          cosign version

      # Login for signature push
      - name: Login to Docker Hub for Cosign
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | \
            cosign login docker.io \
              -u "${{ secrets.DOCKER_USERNAME }}" \
              --password-stdin

      # Sign image 
      - name: Sign Docker image
        env:
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: |
          set -x
          printf "%s" "${{ secrets.COSIGN_PRIVATE_KEY }}" > cosign.key

          cosign sign --yes \
            --key cosign.key \
            index.docker.io/${{ env.IMAGE_REF }}@${{ env.DIGEST }}

      # Wait for registry consistency
      - name: Wait for Docker Hub consistency
        run: sleep 30

      # Verify signature
      - name: Verify Docker image signature
        run: |
          set -x
          printf "%s" "${{ secrets.COSIGN_PUBLIC_KEY }}" > cosign.pub

          cosign verify \
            --key cosign.pub \
            index.docker.io/${{ env.IMAGE_REF }}@${{ env.DIGEST }}
